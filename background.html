<html>
<head>
<script>
var TEMP;
var js;
var link;
var allLinks;

// When using experimental API, change this flag to true, and add
// an "experimental" permission in manifest.json
var useExperimentalAPI = false;

// Check if Thunder/Flashget is enabled
function scanTF() {
  localStorage.thunder = pluginobj.thunderIsEnabled();
  localStorage.flashget = pluginobj.flashgetIsEnabled();
}

function setPopupStatus() {
  //scanTF();

  chrome.browserAction.setTitle({title: chrome.i18n.getMessage('tipUnable')});
  chrome.browserAction.setIcon(
      {path: chrome.extension.getURL('logo_64_disable.png')});
  chrome.browserAction.setPopup({popup: ''});
  chrome.tabs.getSelected(null, function(tab) {
    chrome.tabs.sendRequest(tab.id, {msg: 'content_script_is_load'}, function(response) {
      var browserActionTitle;
      var setBrowserActionIcon = 'logo_64_disable.png';
      var setPopupUrl = '';
      if (response && response.msg == 'noLinks') {
        browserActionTitle = chrome.i18n.getMessage('tipNolink');
      } else if (response.msg == 'haveLinks') {
        setBrowserActionIcon = 'logo_64.png'
        if (localStorage.thunder == 'true' && localStorage.flashget == 'true') {
          browserActionTitle = chrome.i18n.getMessage('downloadAllByThunderAndFlashget');
          setPopupUrl = 'popup.html';
        } else if (localStorage.flashget == 'true') {
          browserActionTitle = chrome.i18n.getMessage('downloadAllByFlashget');
        } else if (localStorage.thunder == 'true') {
          browserActionTitle = chrome.i18n.getMessage('downloadAllByThunder');
        } else {
          setBrowserActionIcon = 'logo_64_disable.png';
          browserActionTitle = chrome.i18n.getMessage('noDownloader');
          chrome.browserAction.setIcon(
              {path: chrome.extension.getURL('logo_64_disable.png')});
        }
      }
      console.log('browserActionTitle: ' + browserActionTitle);
      chrome.browserAction.setTitle({title: browserActionTitle});
      chrome.browserAction.setIcon(
          {path: chrome.extension.getURL(setBrowserActionIcon)});
      chrome.browserAction.setPopup({popup: setPopupUrl});
    });
  });
}
chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
 
  setPopupStatus();
});

chrome.browserAction.onClicked.addListener(function(tab) {
  if (localStorage.thunder == 'true' && localStorage.flashget == 'false') {
      chrome.tabs.executeScript(tab.id, {code: 'downloadAllByThunder()'});
    } else if (localStorage.thunder == 'false' && localStorage.flashget == 'true') {
      chrome.tabs.executeScript(tab.id, {code: 'downloadAllByFlashget()'});
    }
});

function addMyItemToContextMenu() {
  var downloaderName;
  if (eval(localStorage.flashget)) {
    downloaderName = chrome.i18n.getMessage('mFlashget');
    chrome.experimental.contextMenu.create(
        {'title': downloaderName,
         'contexts': ['LINK'],
         'onclick': function(obj){
           pluginobj.flashgetAddLink(obj.linkUrl, '', obj.mainFrameUrl);
         }});
    downloaderName = chrome.i18n.getMessage('downloadAllByFlashget');
    chrome.experimental.contextMenu.create(
      {'title': downloaderName,
       'contexts': ['ALL'],
       'onclick': function(obj) {
         if (obj.frameUrl) {
           chrome.tabs.executeScript(null, {code: 'downloadAll("' + obj.frameUrl + '", "flashget")', allFrames: true})
         } else {
           chrome.tabs.executeScript(null, {code: 'downloadAllByFlashget();'})
         }
       }});
  }
  if (eval(localStorage.thunder)) {
    downloaderName = chrome.i18n.getMessage('mThunder');
    chrome.experimental.contextMenu.create(
        {'title': downloaderName,
         'contexts': ['LINK'],
         'onclick': function(obj) {
           pluginobj.thunderAddLink(obj.linkUrl, '', obj.mainFrameUrl);
         }});

    downloaderName = chrome.i18n.getMessage('downloadAllByThunder');
    chrome.experimental.contextMenu.create(
      {'title': downloaderName,
       'contexts': ['ALL'],
       'onclick': function(obj) {
         if (obj.frameUrl) {
           chrome.tabs.executeScript(null, {code: 'downloadAll("' + obj.frameUrl + '", "thunder")', allFrames: true})
         } else {
           chrome.tabs.executeScript(null, {code: 'downloadAllByThunder();'})
         }

        // chrome.tabs.executeScript(null, {code: 'downloadAll();', allFrames: true})
       }});

    downloaderName = chrome.i18n.getMessage('option');
    chrome.experimental.contextMenu.create(
      {'title': downloaderName,
       'contexts': ['ALL'],
       'onclick': function() {
            chrome.tabs.create({'url': 'options.html'})
            }});
  }
}

function downloadLinkByFlashget(link) {
  pluginobj.flashgetAddLink(link[0], link[1], link[2]);
}

function downloadLinkByThunder(link) {
  pluginobj.thunderAddLink(link[0], link[1], link[2]);
}

function init() {
  chrome.tabs.onSelectionChanged.addListener(function(tabId) {

    js = 'chrome.tabs.executeScript(' + tabId + ', {file: "npdownload.js"});';
    chrome.tabs.sendRequest(tabId, {
        "msg": 'init_check',
        "downloader": localStorage.downloader,
        "contextmenu": localStorage.contextmenu,
        "flashget": localStorage.flashget,
        "thunder": localStorage.thunder
    }, function(response) {
      // If content script is loaded
      if (response) {
        js = "";
      }
    });
    setTimeout(function() {
      eval(js);
      setPopupStatus();
    }, 500);
  });

  chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
    if (request.command == 'isUseExperimentalAPI') {
      sendResponse({'useExperimentalAPI': useExperimentalAPI});
    }
    if (request.command == 'update') {
      if (localStorage.contextmenu == "") {
        localStorage.contextmenu = 'true';
      }
      sendResponse({
          "downloader": localStorage.downloader,
          "contextmenu": localStorage.contextmenu,
          "flashget": localStorage.flashget,
          "thunder": localStorage.thunder});
    } else if (request.command == 'disable') {
      localStorage.contextmenu = 'false';
      sendResponse(localStorage.contextmenu);
    } else if (request.command == 'flashget' ||
        request.command == '' && localStorage.downloader == 'flashget') {
      sendResponse(true);
      downloadLinkByFlashget(request.content);
    } else if (request.command == 'thunder' ||
        request.command == '' && localStorage.downloader == 'thunder') {
      sendResponse(true);
      downloadLinkByThunder(request.content);
    } else {
      sendResponse(false);
    }
  });
  chrome.extension.onConnect.addListener(function(port) {
    port.onMessage.addListener(function(message) {
      if (message) {
        switch (message.command) {
          case 'ThunderEnd':
            eval(message.content);
            break;
          case 'FlashgetEnd':
            eval(message.content);
            break;
        }
      }
    });
  });

  scanTF();
  setPopupStatus();
  if (useExperimentalAPI) {
    addMyItemToContextMenu();
  }
  localStorage.contextmenu = 'true';
}
</script>
</head>
<body onload="init()">
<object id="pluginobj" type="application/x-downloadhelper" hidden="true">
Failed to load np plugin. You might be using the old version of the extension.</object>
</body>
</html>
