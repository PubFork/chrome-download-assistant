<!DOCTYPE html>
<html>
<head>
<title> Download Helper Options </title>
<style>
  body {
    margin:10px;
    font-size:13px;
    background: #EBEFF9;
    font-family: arial, sans-serif;
  }
  #header {
    padding-bottom:1em;
    padding-top:1em;
  }
  #header h1 {
    font-size: 30px;
    display:inline;
    color: #3d5d6a;
    padding-bottom:40px;
    padding-left:90px;
    padding-top:70px;
    background:url(images/icon_48.png) no-repeat 1px 62px;
  }
  a {
    color: #1C7EC5;
    text-decoration: underline;
    cursor: pointer;
  }
  #downloader {
    border-bottom: 3px dotted #CCDDED;
  }
  .downloaderOptionTitle {
    padding-left:0.5em;
    color: #333333;
    line-height: 28px;
    font-size:15px;
  }
  p {
    padding-left:2em;
    font-size:14px;
  }
  .section-header {
    background:#ebeff9;
    border-top:1px solid #b5c7de;
    font-size:99%;
    padding:3px 0 2px 5px;
    font-weight:bold;
    margin-bottom:1em;
    margin-top:1em;
  }
  .contentBox {
    background-color: #ffffff;
    border: 3px solid #bec9ce;
    -webkit-border-radius: 20px 20px;
    padding: 30px;
    text-align: left;
    margin: 50px auto 20px auto;
    width: 600px;
  }
  #contextMenuItem {
    margin-left: 32px;
  }
  #footer {
    text-align: center;
    font-size: 13px;
  }
  table {
     border-collapse: collapse;
  }
  .downloaderItem {
    background: -webkit-gradient(linear, 0% 0%, 0% 100%,
        from(#FEFEFE), to(#eff8fa));
    height: 27px;
    border-bottom: 1px #dee7ee solid;
  }
  .downloaderItem th {
    font-size: 12px;
    color : #1a82c4;
    height: 25px;
    border-right: 1px solid #D0D0D0;
    color: #5e769c;
  }
  .th0 {
    width: 70px;
    min-width: 62px;
    height: auto;
  }
  .th1 {
    width: 130px;
    height: auto;
  }
  .th0 div{
    float: right;
    padding-right: 20px;
  }
  .th1  div {
    float: left;
    padding-left: 12px;
  }
  .th2 {
    width: 285px;
    height: auto;
  }
  .th2 div {
    float: left;
    padding-left: 20px;
  }
  .th3 {
    width: 105px;
    height: auto;
    font-size: 12px;
  }
  .th3 .btnDiv {
    float: right;
  }
  #downloaderSetting {
    font-weight: bolder;
  }
  .itemImg {
   float: right;
   padding-right: 7px;
   cursor: pointer;
   width: 30px;
   height: 30px;
  }
  .itemName {
    width: 110px;
    float: left;
    margin-left: 11px;
  }
  .itemParameter {
    width: 255px;
    float: left;
    padding-left: 3px;
    margin-left: 17px;
  }
  button {
   cursor: pointer;
  }
  .downloaderItemContainer {
    background-color: #f6fbff;
  }
  .downloaderItemContainer tr{
    height: 45px;
    border: 0;
  }
  input[type=text] {
    height: 22px;
    border: 1px solid #c1d1e0;
    background: -webkit-gradient(linear, 0% 0%, 0% 100%,
        from(#FFFFFF), to(#edf5f5));
  }
  .addURL-Dialog {
    z-index: 1000;
    background: -webkit-gradient(linear, 0% 0%, 0% 100%,
        from(#d0e1f3), to(#f5f9fc));
    width: 285px;
    height: 155px;
    border: 1px solid #a2bad4;
    display: none;
    position: absolute;
    -webkit-border-radius: 5px;
    -webkit-box-shadow:  #CCC 0px 0px 7px 1px;
  }
  .addURL-Dialog .body {
    background-color: White;
    width: 265px;
    height: 100px;
    margin: 10px 10px;
  }
  .addURL-Dialog input {
    width: 230px;
    margin-top: 10px;
  }
  .addURL-Dialog .bottom {
    height: 50px;
    width: 285px;
    margin: auto;
  }
 .addURL-Dialog .bottom .btnDiv {
    float: right;
    padding-right: 10px;
  }
  #urlAddress {
    font-weight: bold;
    color: #6587a2;
  }
  #bottomLine {
    border-top: 1px solid #c1d1e0;
  }
  #downloaderContainer {
    display: none;
  }
  #downloaderSettingTitle {
     margin: 20px 0 0 0;
     display: none;
  }
  #downloaderOption {
    padding-left: 16px;
  }
  #downloaderOption span {
    padding-left: 5px;
  }
  #downloaderOption div {
    padding: 5px 0 5px ; 
  }
  #downloaderOPtion input {
   margin: 0 3px 3px 5px;
  }
  #linuxTitleLine {
    border-bottom: 3px dotted #CCDDED;
    margin: 0;
    display: none;
  }
</style>
</head>
<body onload="init();">
<div class="contentBox">
  <div id="header">
    <h1><span id="pageTitle"></span></h1>
  </div>
  <h4 id="downloader" class="downloaderOptionTitle"></h4>
  <table>
  <tr>
  <td>
    <div id="downloaderOption"></div>
  </td>
  <td>
  </td>
  </tr>
  </table>
  <div  id="selectDefaultDownloaderPrompt" style="margin:16px 0;font-size: 12px; display:none;
     background-color: #f6fbff ;border:1px #ecf6fe solid;height: 50px;">
     <div style="padding: 10px 0 0 25px;">
      <span  id="selectDefaultDownloader"></span>
      <a  id="downloaderSettingsPrompt" href="javascript:" onclick="document.
          getElementById('downloaderContainer').style.display='block'"></a></div>
       </div>
  <div id="contextMenuItem"><label><input type="checkbox" id="checkboxContextMenu">
    <span id="disableMenu"></span></label>
  </div>
  <div id="downloaderSettingTitle">
    <span id="downloaderSetting" class="downloaderOptionTitle"></span>
    <img id="visibleAddDownloaderPanel"  src="images/down.png"
         style="float: right;margin-right: 5px;cursor: pointer;">
  </div>  
         <h4 id="linuxTitleLine"></h4>
  <div id="downloaderContainer">
  <div style="margin:16px 0;font-size: 12px; background-color: #f6fbff ;
      border:1px #ecf6fe solid;height: 65px;">
    <div style="padding: 10px 0 0 25px;">
    <span  id="downloaderSettings"></span>
    </div>
       </div>
    <div class="downloaderItem">
      <table>
        <tr>
          <th class="th0"><div id="downloaderIcon"></div></th>
          <th class="th1"><div id="downloaderName"></div></th>
          <th class="th2"><div  id="downloaderParameter"></div></th>
          <th class="th3"><div></div></th>
        </tr>
      </table>
    </div>
    <div class="downloaderItemContainer">
      <div>
        <table id="downloaderlist"></table>
      </div>
      <div>
        <table>
          <tr>
            <td class="th0"><img id="settingImg" class="itemImg"
                style="padding-right:5px" src="images/icon-nomal.png"></td>
            <td class="th1"><input id="settingName" class="itemName"
                type="text"></td>
            <td class="th2"><input id="settingParameter" class="itemParameter"
                type="text"></td>
            <td class="th3">
              <div class="btnDiv">
                <button  id="addDownloader"></button>
              </div>
            </td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  <div>
    <div id="addURLDialog" class="addURL-Dialog">
      <div class="body">
        <div style="padding:20px">
          <div id="urlAddress"></div>
          <input type="text" id="iconURL">
        </div>
      </div>
      <div class="bottom"><div class="btnDiv">       
        <button  id="addURLOkBtn"></button>
        <button  id="addURLCancelBtn"></button>
      </div></div>
    </div> 
  </div>
  <h4 id="bottomLine"></h4>
   <div id="closeBtn">
      <button  id="saveAndClose"  onclick="saveAndClose()"></button>
    </div>
</div>
<div id="footer" style="margin: 30px 0 0 0;">&copy;2011 Google</div>
<script>
  function $(id) {
    return document.getElementById(id);
  }

  var defaultDownloader =
      localStorage['defaultDownloader'] || 'chrome_downloader';
  var checkboxContextMenu = $('checkboxContextMenu');
  var bg = chrome.extension.getBackgroundPage();
  var downloaderManager = bg.downloaderManager;

  function init() {
    i18nReplace('pageTitle', 'page_title');
    i18nReplace('downloader', 'downloader');
    i18nReplace('disableMenu', 'menu_disable');
    i18nReplace('saveAndClose', 'save_and_close');
    bg.updateDownloadersIfNeeded();
    createDownloaderOption($('downloaderOption'));
    if (bg.useContextMenuAPI) {
      $('contextMenuItem').style.display = 'none';
    } else if (!eval(localStorage['contextMenu'])) {
      checkboxContextMenu.checked = true;
    }
    if (linuxoptions.isLinuxPlatform()) {
      linuxoptions.init();
    }
  }

  function createDownloaderOption(element) {
    var enableOptions = bg.enableDownloaders;
    for (var i = 0; i < enableOptions.length; i++) {
      var item = enableOptions[i];
      var imageUrl = '';
      var optionItemId = ''
      if (item.isLinux) {
        imageUrl = item.image;
        optionItemId = item.command;
      } else {
        imageUrl = chrome.extension.getURL(item.image);
      }
      addDownloaderOption(element, imageUrl, item.name, optionItemId)
    }
  }
  
  function addDownloaderOption(element, imageUrl, name, id) {
      var option = document.createElement('div');
      if (linuxoptions.isLinuxPlatform()) {
        option.id = id;
      }
      var label = document.createElement('label');
      var radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = 'downloader';
      radio.value = name;
      if (defaultDownloader == radio.value) {
        radio.checked = true;
      }
      label.appendChild(radio);
      (function(radio) {
        radio.onchange = function() {
          if (radio.checked) {
            defaultDownloader = radio.value;
          }
        }
      })(radio);
      
      var img = document.createElement('img');
      img.src = imageUrl;
      img.style.height = '30px';
      img.style.weight = '30px';
      label.appendChild(img);
      
      var span = document.createElement('span');
      span.innerText = chrome.i18n.getMessage(name) || name;
      label.appendChild(span);
      option.appendChild(label);
      element.appendChild(option);
  }

  function saveAndClose() {
    localStorage['defaultDownloader'] = defaultDownloader;
    localStorage['contextMenu'] = (checkboxContextMenu.checked ? 'false' : 'true');
    if (linuxoptions.isLinuxPlatform()) {
        linuxoptions.deleteDownLoaderStorage();
        linuxoptions.saveDownloader();
    }
    chrome.tabs.getSelected(null, function(tab) {
      chrome.tabs.remove(tab.id);
    });
  };

  function i18nReplace(id, messageName) {
    return $(id).innerHTML =
      chrome.i18n.getMessage(messageName);
  };

  var linuxoptions = {
    rowCount: 0,
    storageTempArr: [],
    deleteRowCounts:[],

    init: function() {
      i18nReplace('downloaderSetting', 'downloader_setting');
      i18nReplace('downloaderIcon', 'downloader_icon');
      i18nReplace('downloaderName', 'downloader_name');
      i18nReplace('downloaderParameter', 'downloader_parameter');
      i18nReplace('addDownloader', 'add_downloader');
      i18nReplace('urlAddress', 'url_address');
      i18nReplace('addURLOkBtn', 'add_url_ok_btn');
      i18nReplace('addURLCancelBtn', 'add_url_cancel_btn');
      i18nReplace('downloaderSettings', 'downloader_settings');
      i18nReplace('selectDefaultDownloader', 'select_default_downloader');
      i18nReplace('downloaderSettingsPrompt', 'downloader_settings_prompt');
      linuxoptions.displayLinuxOptionPage();
      linuxoptions.setPromptText();
      linuxoptions.addEventListener();
      linuxoptions.readDownloader();
      linuxoptions.displaySelectDafaultDownloaderPormpt();
    },

    addEventListener: function() {
      $('settingImg').addEventListener('mouseover', function() {
        if (this.src.indexOf('images/icon-nomal.png') != -1) {
        this.src = 'images/icon-over.png';
        }
      }, false);

      $('settingImg').addEventListener('mouseout', function() {
        if (this.src.indexOf('images/icon-over.png') != -1) {
          this.src = 'images/icon-nomal.png';
        }
      }, false);

      $('settingImg').addEventListener('click', function() {
        var addURLDialog = $('addURLDialog');
        addURLDialog.style.display = 'block';
        addURLDialog.style.top =  (document.body.scrollTop +
            (document.documentElement.clientHeight - 200 -
            addURLDialog.offsetHeight) / 2) + 'px';
        addURLDialog.style.left =  (document.body.scrollLeft +
            (document.documentElement.clientWidth -
            addURLDialog.offsetWidth) / 2) + 'px';
      }, false);

      $('addURLOkBtn').addEventListener('click', function() {
        $('settingImg').src = $('iconURL').value;
        linuxoptions.closeAddURLDialog();
      }, false);

      $('addURLCancelBtn').addEventListener('click', function() {
        linuxoptions.closeAddURLDialog();
      }, false);

      $('visibleAddDownloaderPanel').addEventListener('click', function() {
        var downloaderContainer = $('downloaderContainer');
        if ('none' == downloaderContainer.style.display) {
          downloaderContainer.style.display = 'block';
          this.src = 'images/up.png';
        } else {
          downloaderContainer.style.display = 'none';
          this.src = 'images/down.png';
        }
      }, false);

      $('addDownloader').addEventListener('click', function() {
        var imgsrc = $('settingImg').src;
        var downloaderName = $('settingName').value;
        var dowloaderParameter = $('settingParameter').value;
        var isInstallation = linuxoptions.addDownloadertoSettingTable(imgsrc, 
            downloaderName, dowloaderParameter);
        if (isInstallation) {
          addDownloaderOption($('downloaderOption'), imgsrc, downloaderName,
              dowloaderParameter);
        }
      }, false);

      $('settingName').addEventListener('focus', function() {
        if (this.value ==  chrome.i18n.getMessage('setting_name')) {
          this.value = '';
          this.style.color = '#000000';
        }
      });

      $('settingName').addEventListener('blur', function() {
        if (this.value == '') {
          this.value = chrome.i18n.getMessage('setting_name');
          this.style.color =  '#a5a5a5';
        }
      });

      $('settingParameter').addEventListener('focus', function() {
        if (this.value ==  chrome.i18n.getMessage('setting_parameter')) {
          this.value = '';
          this.style.color = '#000000';
        }
      });

      $('settingParameter').addEventListener('blur', function() {
        if (this.value == '') {
          this.value = chrome.i18n.getMessage('setting_parameter');
          this.style.color =  '#a5a5a5';
        }
      });

      $('iconURL').addEventListener('focus', function() {
        if (this.value ==  chrome.i18n.getMessage('icon_url')) {
          this.value = '';
          this.style.color = '#000000';
        }
      });

      $('iconURL').addEventListener('blur', function() {
        if (this.value == '') {
          this.value = chrome.i18n.getMessage('icon_url');
          this.style.color =  '#a5a5a5';
        }
      });
    },

    setPromptText: function() {
      var settingName = $('settingName');
      var settingParameter = $('settingParameter');
      var iconURL = $('iconURL');
      settingName.value = chrome.i18n.getMessage('setting_name');
      settingName.style.color = '#a5a5a5';
      settingParameter.value = chrome.i18n.getMessage('setting_parameter');
      settingParameter.style.color = '#a5a5a5';
      iconURL.style.color = '#a5a5a5';
      iconURL.value = chrome.i18n.getMessage('icon_url');
    },
    
    displaySelectDafaultDownloaderPormpt: function() {
      var defaultDownloaderProId = ['flashget', 'jdownloader', 'gwget'];
      for (var i = 0; i < defaultDownloaderProId.length; ++i) {
        if (!(bg.plugin.CheckObject(defaultDownloaderProId[i]))) {
          $('selectDefaultDownloaderPrompt').style.display = 'block';
          return;
        }
      }
    },
    
    addDownloadertoSettingTable: function(imgsrc, downloaderName, dowloaderParameter) {
      var projId = dowloaderParameter.split(' ')[0];
      if (!bg.plugin.CheckObject(projId) || ''==projId) {
        return false;
      }
      linuxoptions.insertOneRowInTable(linuxoptions.rowCount, imgsrc,
          downloaderName, dowloaderParameter);
      linuxoptions.setRowBackgroundColor();
      linuxoptions.rowCount++;
      linuxoptions.temporaryStorage(imgsrc, downloaderName,
          dowloaderParameter);
      linuxoptions.cleanAddedDownloaderSettingData();
      return true;
    },

    insertOneRowInTable: function(rowCount, imgsrc, name, parameter) {
      var downloaderItem = $('downloaderlist');
      var row = downloaderItem.insertRow(rowCount);
      linuxoptions.insertImageToTheRow(row, imgsrc);
      linuxoptions.insertNameOrLinkToTheRow(row, 1, name);
      linuxoptions.insertNameOrLinkToTheRow(row, 2, parameter);
      linuxoptions.insertOptionsToTheRow(row);
    },
    
    setRowBackgroundColor: function() {
      var table = $('downloaderlist');
      var rows = table.rows;
      for(var i = 0; i < rows.length; ++i) {
        if ((i + 1) % 2 != 0) {
          rows[i].style.backgroundColor = 'White';
        } else {
          rows[i].style.backgroundColor = '#f6fbff';
        }
      }
    },

    insertImageToTheRow: function(row, src) {
      var cell = row.insertCell(0);
      cell.className = 'th0';
      var img = document.createElement('img');
      img.className = 'itemImg';
      img.src = src;
      cell.appendChild(img);
    },

    insertNameOrLinkToTheRow: function(row, cellCount, value) {
      var cell = row.insertCell(cellCount);
      cell.className = 'th' + cellCount;
      var input = document.createElement('input');
      input.setAttribute('readonly', 'readonly');
      input.onblur = linuxoptions.saveModification;
      input.className = cellCount == 1 ? 'itemName' : 'itemParameter';
      input.style.border = '0';
      input.style.background = '0';
      input.value = value;
      cell.appendChild(input);
    },

    insertOptionsToTheRow: function(row) {
      var cell = row.insertCell(3);
      cell.className = 'th3';

      var aModify = document.createElement('A');
      aModify.innerText =  chrome.i18n.getMessage('modify');
      aModify.href = 'javascript:';
      aModify.onclick = linuxoptions.modifyDownloader;

      var  aDelete = document.createElement('A');
      aDelete.innerText =  chrome.i18n.getMessage('delete');
      aDelete.href = 'javascript:';
      aDelete.style.paddingLeft = '5px';
      aDelete.onclick = linuxoptions.deleteDownloader;

      cell.appendChild(aModify);
      cell.appendChild(aDelete);
    },

    saveModification : function(event) {
      var obj = event.target;
      var tr = obj.parentNode.parentNode;
      var rowCount = tr['rowIndex'];
      var imgSrc = tr.getElementsByTagName('img')[0].src;
      var inputArr = tr.getElementsByTagName('input');
      var downloaderName = inputArr[0].value;
      var downloaderParameter = inputArr[1].value;
      linuxoptions.modifyTemporaryStorage(
          rowCount, imgSrc, downloaderName, downloaderParameter);
    },

    modifyDownloader: function(event) {
      var obj = event.target;
      var td = obj.parentNode.parentNode;
      var inputArr = td.getElementsByTagName("input");
      for (var i = 0; i < inputArr.length; i++) {
        inputArr[i].removeAttribute('readonly');
      }
      inputArr[0].focus();
    },

    deleteDownloader: function(event) {
      var obj = event.target;
      var tr = obj.parentNode.parentNode;
      linuxoptions.deleteOptionDownLoader(tr);
      linuxoptions.deleteTemporaryStorage(tr['rowIndex']);
      linuxoptions.deleteRowCounts.push(tr['rowIndex']);
      var tbody = tr.parentNode;
      tbody.removeChild(tr);
      linuxoptions.rowCount--;
      linuxoptions.setRowBackgroundColor();
    },
    
    deleteOptionDownLoader: function(tr) {
      var input = tr.childNodes[2].firstChild
      var id = input.value;
      $('downloaderOption').removeChild($(id));      
    },
    
    deleteDownLoaderStorage: function() {
      for (var i = 0; i < linuxoptions.deleteRowCounts.length; ++i) {
        var localStorageName = 'downloaderConfigure' + linuxoptions.deleteRowCounts[i]
        localStorage.removeItem(localStorageName);
        for (var j = 0; j<  downloaderManager.menuItems.length; ++j) {
          if(downloaderManager.menuItems[j].storageName == localStorageName) {
            downloaderManager.menuItems.splice(j,1);
          }
        }
      }
    },

    displayLinuxOptionPage: function() {
      $('downloaderSettingTitle').style.display = 'block';
      $('linuxTitleLine').style.display = 'block';
      $('bottomLine').style.display = 'block';
      $('closeBtn').style.cssFloat = 'right';
    },

    closeAddURLDialog: function() {
      $('addURLDialog').style.display = 'none';
    },

    temporaryStorage: function(imgsrc, name, parameter) {
      var tempArr = [imgsrc, name, parameter];
      linuxoptions.storageTempArr.push(tempArr);
    },

    modifyTemporaryStorage: function(index, imgsrc, name, parameter) {
      var tempArr = [imgsrc, name, parameter];
      linuxoptions.storageTempArr[index] = tempArr;
    },

    deleteTemporaryStorage: function(index) {
      linuxoptions.storageTempArr.splice(index, 1);
    },

    saveDownloader: function() {
      var count = 0;
      var newItem = linuxoptions.storageTempArr[count];
      for (var i = 0; i < downloaderManager.menuItems.length; i++) {
        var item = downloaderManager.menuItems[i];
        if (count < linuxoptions.storageTempArr.length &&
            newItem[0] == item.image && newItem[1] == item.name &&
            newItem[2] == item.command) {
          if (item.storageName &&
              item.storageName != 'downloaderConfigure' + count) {
            localStorage['downloaderConfigure' + count] =
                localStorage[item.storageName];
            localStorage.removeItem(item.storageName);
          }
          count++;
          newItem = linuxoptions.storageTempArr[count];
        }
      }
      for (; count < linuxoptions.storageTempArr.length; count++) {
        var name = 'downloaderConfigure' + count;
        var tempArr = linuxoptions.storageTempArr[count];
        localStorage[name] = [tempArr[0], tempArr[1], tempArr[2]];
        downloaderManager.addCustomDownloader(name, tempArr);
      }
    },

    readDownloader: function() {
      var count = 0;
      for (var i = 0; i < downloaderManager.menuItems.length; i++) { 
        var item = downloaderManager.menuItems[i];  
        if (item.isLinux && item.isUserAdd) {
          var projId = item.command.split(' ')[0];
          if(bg.plugin.CheckObject(projId)){   
            linuxoptions.insertOneRowInTable(
                count, item.image, item.name, item.command);
            count++;
            linuxoptions.temporaryStorage(item.image, item.name,
                item.command);
           }
        }
      }
      linuxoptions.rowCount = count;
      linuxoptions.setRowBackgroundColor();
    },

    cleanAddedDownloaderSettingData: function() {
      $('settingImg').src = 'images/icon-nomal.png';
      $('settingName').value = '';
      $('settingParameter').value = '';
    },

    isLinuxPlatform: function() {
      return navigator.userAgent.toLowerCase().indexOf('linux') > -1;
    }
  }
</script>
</body>
</html>
